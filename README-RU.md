[![Build Status](https://github.com/Maslinin/Consyzer/workflows/Build/badge.svg)](https://github.com/Maslinin/Consyzer/actions/workflows/build.yml) [![Quality Gate Status](https://sonarcloud.io/api/project_badges/measure?project=Maslinin_Consyzer&metric=alert_status)](https://sonarcloud.io/summary/new_code?id=Maslinin_Consyzer) [![Coverage](https://sonarcloud.io/api/project_badges/measure?project=Maslinin_Consyzer&metric=coverage)](https://sonarcloud.io/summary/new_code?id=Maslinin_Consyzer) [![GitHub license](https://badgen.net/github/license/Maslinin/Consyzer)](https://github.com/Maslinin/Consyzer/blob/master/LICENSE)

# Описание
**Consyzer** - утилита, созданная для решения проблем консистентности развернутых в системе сборок CIL.

## Для чего?
Представим, что в исходном коде некоего приложения есть вызовы к функциям, находящимся в сторонних неуправляемых библиотеках динамической компоновки (DLL). 
В исходном коде CIL модуля такие вызовы описываются с помощью атрибута **DllImport** и сохрананяются в его метаданных после сборки приложения.        
Ключевой особенностью атрибута **DllImport** является то,
что вызываемая из неуправляемой DLL функция не компонуется с исходным кодом CIL модуля напрямую; 
вместо этого в метаданных модуля сохраняется информация об импортируемой функции, в том числе и ссылка на ожидаемое местоположение неуправляемой DLL в системе, в которой эта функция определена.          
```
//В данном контексте "kernel32.dll" является относительным путем к DLL, содержащей определение функции HelloWorld:
[DllImport("kernel32.dll")]
static extern void HelloWorld();
```

Приложение работает корректно, не нарушая целостность и безопасность системы, если все неуправляемые DLL находятся на их ожидаемом согласно метаданным местоположении;
но если хотя бы одна из DLL будет отсутствовать, приложение не только завершит свою работу аварийно, но и может привести к нарушению безопасности всей системы.              

Именно для предотвращения подобного рода инцидентов и был разработан Consyzer.

## Преимущества Consyzer
1. Consyzer является независимым от GUI и легко запускается из *CLI*;
2. Consyzer может быть легко интегрирован в *конвейер CI/CD*;
3. Consyzer логгирует подробную информацию о каждой импортируемой функции, вплоть до её сигнатуры;
4. Consyzer возвращает конкретный код анализа операционной системе, что позволяет индивидуально реагировать на каждый из инцидентов анализа.

## Какую информацию логгирует Consyzer об импортируемой функции?
Если *Consyzer* обнаружил импортируемую функцию, он логгирует следующую информацию об этой функции:
1. Имя функции,
2. Сигнатуру функции,
3. Ожидаемое местоположении неуправляемой DLL c определением этой функции в системе,
4. Аргументы атрибута DllImport.

## Коды возврата
> 0 - все используемые приложением DLL находятся в анализируемой директории вместе с артефактами приложения;       
> 1 - одна или несколько DLL, используемая в CIL модуле приложения, находится на абсолютном пути;        
> 2 - одна или несколько DLL, используемая в CIL модуле приложения, находится на относительном пути;        
> 3 - одна или несколько DLL, используемая в CIL модуле приложения, находится в системной папке;        
> 4 - одна или несколько DLL, используемая в CIL модуле приложения, отсутствуют на пути, указанном в метаданных модуля.         

> Обратите внимание, что только последний из кодов возврата означает о нарушении консистентности приложения.

# Запуск    
Утилите на вход передается два параметра: 
1. Директория, содержащая CIL файлы для анализа. Это могут быть выходные артефакты проекта;
2. Расширения файлов, подлежащих анализу.

Общий шаблон запуска *Consyzer* из CLI выглядит следующим образом:
```
pathToConsyzer pathToFolderWithApplicationArtifacts extensionsOfAnalyzedFiles
```

Пример запуска *Consyzer* из CLI:
```
C:\Consyzer.exe C:\folderToBeAnalyzed ".exe, .dll"
```

## Анализ нескольких проектов
Вы можете использовать сценарий *PowerShell*, находящийся по пути ```DevOps\Runner.ps1``` для анализа выходных артефактов всех проектов в решении с помощью *Consyzer*. 
Это также может быть полезно *конвейере CI/CD*.

Подробнее читайте в ```DevOps\README.md```.